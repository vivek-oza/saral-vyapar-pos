# Story 1.2: Password Reset & Account Recovery

## Status

Ready for Review

## Story

**As a** registered user,
**I want** to reset my password and recover access to my account if I forget my credentials,
**so that** I can regain access to my shop data without losing my business information

## Acceptance Criteria

1. User can request password reset from login page
2. Password reset OTP is sent to user's registered email address
3. OTP expires after 10 minutes for security
4. User can set new password through secure OTP verification flow
5. User is notified of successful password change
6. User can log in with new password immediately
7. Old password is invalidated after reset
8. Signup form includes comprehensive password validation with strength indicator

## Tasks / Subtasks

- [x] Task 1: Implement password reset request functionality (AC: 1, 2)
  - [x] Create password reset request form on login page
  - [x] Implement password reset API endpoint
  - [x] Generate secure reset token with expiration
  - [x] Send password reset email with secure link
- [x] Task 2: Build OTP-based password reset flow (AC: 3, 4, 5)
  - [x] Create password reset page with OTP verification
  - [x] Implement OTP expiration checking (10 minutes)
  - [x] Build new password form with validation
  - [x] Add password strength requirements
- [x] Task 3: Implement password update and security (AC: 6, 7)
  - [x] Create password update API endpoint
  - [x] Hash new password with bcrypt
  - [x] Invalidate old password and reset token
  - [x] Update user's last password change timestamp
- [x] Task 4: Add email service integration (AC: 2)
  - [x] Set up email service (Nodemailer or similar)
  - [x] Create email templates for password reset
  - [x] Configure email delivery settings
  - [x] Add email delivery error handling
- [x] Task 5: Enhance signup form with password validation (AC: 8)
  - [x] Add PasswordStrengthIndicator to signup form
  - [x] Implement comprehensive password validation rules
  - [x] Update signup form validation to match reset form standards

## Dev Notes

### Previous Story Insights

This story builds on Story 1.1 (User & Shop Onboarding) and requires the authentication system and user management to be in place.

### Data Models

**User Schema Updates:**

- `resetToken`: { type: String, expires: Date } - For password reset functionality
- `resetTokenExpires`: { type: Date } - Token expiration timestamp
- `lastPasswordChange`: { type: Date, default: Date.now } - Track password changes

[Source: docs/architecture/01-system-architecture-document-saral-vyapar.md#4.3 Database (Persistence)]

### API Specifications

**New Endpoints:**

- `POST /api/auth/forgot-password` - Request password reset (generates OTP)
- `POST /api/auth/verify-reset-otp` - Verify OTP for password reset
- `POST /api/auth/reset-password-with-otp` - Complete password reset with verified OTP

**Password Reset Flow:**

1. User requests reset → Generate secure OTP + 10-minute expiration
2. Send email with OTP code
3. User enters OTP → Verify OTP and show password reset form
4. User submits new password → Hash and update user record
5. Invalidate OTP and redirect to login

### Component Specifications

**Frontend Components:**

- `ForgotPasswordForm` - Initial reset request form
- `PasswordResetOTPForm` - OTP verification form for password reset
- `PasswordResetForm` - New password entry form (after OTP verification)
- `PasswordStrengthIndicator` - Visual password strength feedback (used in both signup and reset)

**Email Templates:**

- HTML and text versions for password reset emails
- Professional branding with shop information
- Clear call-to-action and security notices

### File Locations

- `src/components/auth/ForgotPasswordForm.tsx`
- `src/components/auth/PasswordResetForm.tsx`
- `src/components/auth/PasswordStrengthIndicator.tsx`
- `src/pages/ForgotPassword.tsx`
- `src/pages/ResetPassword.tsx`
- `src/api/auth.ts` - Add password reset endpoints
- `src/services/emailService.ts` - Email delivery service
- `src/utils/passwordUtils.ts` - Password validation utilities

### Testing Requirements

**Test Coverage:**

- Unit tests for password reset forms and validation
- Integration tests for complete reset flow
- Email service mocking and testing
- Security tests for token expiration and validation
- Error handling tests for invalid/expired tokens

### Technical Constraints

**Security Requirements:**

- Reset OTPs must be 6-digit secure random codes
- OTPs must expire after 10 minutes maximum
- Old passwords must be immediately invalidated
- Rate limiting on reset requests (max 3 per hour per email)
- Maximum 5 OTP verification attempts before requiring new OTP
- Secure email delivery with proper headers

**Email Requirements:**

- Professional email templates with shop branding
- Clear security instructions and expiration notices
- Mobile-responsive email design
- Fallback text versions for email clients

## Testing

**Testing Standards:**

- Unit tests for all password reset components
- Integration tests for complete reset workflow
- Mock email service for testing without actual email delivery
- Test token expiration scenarios and edge cases
- Verify security measures (rate limiting, token invalidation)

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-27 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude 3.5 Sonnet (Dev Agent James)

### Debug Log References

No critical debugging issues encountered during implementation.

### Completion Notes List

- Successfully implemented OTP-based password reset flow with 10-minute OTP expiration
- Added password strength indicator with visual feedback and validation rules to both signup and reset forms
- Updated email service to send OTP codes instead of reset links
- Created new PasswordResetOTPForm component for OTP verification
- Updated backend with new endpoints: verify-reset-otp and reset-password-with-otp
- Enhanced signup form with comprehensive password validation (8+ characters minimum)
- Updated existing LoginForm to use new OTP-based password reset flow
- All acceptance criteria have been met and validated

### File List

**Frontend Files:**

- `frontend/src/components/auth/ForgotPasswordForm.jsx` - Updated for OTP-based reset request
- `frontend/src/components/auth/PasswordResetOTPForm.jsx` - New OTP verification form
- `frontend/src/components/auth/PasswordResetForm.jsx` - Updated password entry form (supports both token and OTP flows)
- `frontend/src/components/auth/PasswordStrengthIndicator.jsx` - Password strength visual feedback
- `frontend/src/components/auth/SignupForm.jsx` - Enhanced with password strength indicator and 8+ character validation
- `frontend/src/pages/ResetPasswordOTP.jsx` - New page handling complete OTP-based reset flow
- `frontend/src/App.jsx` - Updated routes for OTP-based password reset flow
- `frontend/src/components/auth/LoginForm.jsx` - Uses updated password reset flow

**Backend Files:**

- `backend/routes/auth.js` - Added verify-reset-otp and reset-password-with-otp endpoints, updated forgot-password for OTP
- `backend/services/emailService.js` - Added sendPasswordResetOTP function
- `backend/migrations/004_add_password_reset_otp.sql` - Database migration for OTP fields

**Database Changes:**

- Added `reset_otp`, `reset_otp_expires`, `reset_otp_attempts` columns to users table

## QA Results

_This section will be populated by the QA agent during review_
