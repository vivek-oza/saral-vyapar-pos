# Story 3.1: Core Billing Interface

## Status

Approved

## Story

**As a** cashier or shop owner,
**I want** to create bills quickly using a two-column interface with product search,
**so that** I can serve customers efficiently and minimize checkout time

## Prerequisites

- Story 1.1 (User & Shop Onboarding) must be completed
- Story 1.3 (Module Selection Interface) must be completed
- Story 2.1 (Product Catalog Management) must be completed
- User should access this functionality via the Billing System module

## Acceptance Criteria

1. User can access Billing System from the module selection page at `/{shopusername}/modules`
2. Billing System page replaces the current placeholder implementation
3. Billing interface displays in two-column layout (bill on left, product finder on right)
4. Product search bar allows finding products by name with instant results
5. User can add products to bill with single click
6. Bill shows running total with real-time calculations
7. User can adjust quantities directly in bill items
8. User can remove items from bill
9. Interface is responsive and works on mobile devices
10. Product search includes "Quick Access" and "Top Sellers" tabs
11. User can navigate back to module selection via "Back to Modules" button

## Tasks / Subtasks

- [ ] Task 1: Create billing interface layout (AC: 1, 7)
  - [ ] Implement two-column responsive layout
  - [ ] Create bill column with item list and totals
  - [ ] Build product finder column with search and tabs
  - [ ] Add mobile-responsive design considerations
- [ ] Task 2: Implement product search functionality (AC: 2, 8)
  - [ ] Create search input with debounced search
  - [ ] Build search results display with product cards
  - [ ] Implement "Quick Access" tab for pinned products
  - [ ] Add "Top Sellers" tab with popular products
- [ ] Task 3: Build bill management system (AC: 3-6)
  - [ ] Create bill state management with React Context
  - [ ] Implement add product to bill functionality
  - [ ] Add quantity adjustment controls in bill items
  - [ ] Build remove item functionality
- [ ] Task 4: Implement real-time calculations (AC: 4)
  - [ ] Calculate subtotal for each line item
  - [ ] Sum up total bill amount
  - [ ] Handle tax calculations (if configured)
  - [ ] Update totals on every change
- [ ] Task 5: Add product quick actions (AC: 3, 8)
  - [ ] Implement one-click add to bill
  - [ ] Add product pinning for Quick Access
  - [ ] Build product image display for easy identification
  - [ ] Add stock status indicators

## Dev Notes

### Previous Story Insights

This story builds on Epic 1 (User & Shop Onboarding) and Epic 2 (Product & Inventory Management) and requires the product catalog and authentication system to be complete.

### Data Models

**Bill Schema (Draft):**

- `shop`: { type: ObjectId, ref: 'Shop', required: true }
- `billNumber`: { type: String, unique: true, required: true }
- `timestamp`: { type: Date, default: Date.now }
- `customer`: { `name`: String, `phone`: String }
- `lineItems`: [ { `productId`: ObjectId, `name`: String, `quantity`: Number, `price`: Number, `total`: Number } ]
- `subtotal`: { type: Number, required: true }
- `taxAmount`: { type: Number, default: 0 }
- `totalAmount`: { type: Number, required: true }
- `paymentMode`: { type: String, enum: ['Cash', 'Card', 'UPI'] }
- `status`: { type: String, enum: ['draft', 'completed', 'cancelled'], default: 'draft' }

**Product Schema (from Story 2.1):**

- `shop`, `name`, `basePrice`, `sellingPrice`, `stock`, `category`, `isActive`

[Source: docs/architecture/01-system-architecture-document-saral-vyapar.md#4.3 Database (Persistence)]

### API Specifications

**Product Search Endpoints:**

- `GET /api/products/search?q={query}&limit={limit}` - Search products by name
- `GET /api/products/quick-access` - Get pinned/frequently used products
- `GET /api/products/top-sellers?period={period}` - Get top selling products

**Bill Management Endpoints:**

- `POST /api/bills` - Create new bill
- `PUT /api/bills/:id` - Update bill (draft mode)
- `POST /api/bills/:id/complete` - Complete bill and update inventory

**Query Parameters:**

- `q` - Search query string
- `limit` - Maximum results (default: 10)
- `period` - Time period for top sellers (today, week, month)

### Component Specifications

**Frontend Components:**

- `BillingInterface` - Main two-column layout container
- `BillColumn` - Left column showing current bill
- `ProductFinder` - Right column with search and product selection
- `ProductSearch` - Search input with results
- `QuickAccessTab` - Tab for pinned/frequent products
- `TopSellersTab` - Tab for popular products
- `BillItem` - Individual item in bill with quantity controls
- `BillTotals` - Running totals and calculations
- `ProductCard` - Product display card for selection

**Layout Structure:**

```
┌─────────────────────────────────────────────────────────┐
│                    Billing Interface                    │
├─────────────────────┬───────────────────────────────────┤
│     Bill Column     │        Product Finder             │
│                     │                                   │
│ ┌─────────────────┐ │ ┌─────────────────────────────────┐ │
│ │   Bill Items    │ │ │        Search Bar               │ │
│ │                 │ │ └─────────────────────────────────┘ │
│ │                 │ │ ┌─────────────────────────────────┐ │
│ │                 │ │ │        Quick Access             │ │
│ │                 │ │ │        Top Sellers              │ │
│ │                 │ │ │        Search Results           │ │
│ └─────────────────┘ │ └─────────────────────────────────┘ │
│ ┌─────────────────┐ │                                   │
│ │   Bill Totals   │ │                                   │
│ └─────────────────┘ │                                   │
└─────────────────────┴───────────────────────────────────┘
```

### File Locations

- `src/components/billing/BillingInterface.tsx`
- `src/components/billing/BillColumn.tsx`
- `src/components/billing/ProductFinder.tsx`
- `src/components/billing/ProductSearch.tsx`
- `src/components/billing/QuickAccessTab.tsx`
- `src/components/billing/TopSellersTab.tsx`
- `src/components/billing/BillItem.tsx`
- `src/components/billing/BillTotals.tsx`
- `src/pages/Billing.tsx`
- `src/contexts/BillingContext.tsx` - Bill state management
- `src/api/products.ts` - Add search endpoints
- `src/api/bills.ts` - Bill management endpoints
- `src/utils/billingUtils.ts` - Billing calculations and helpers

### Testing Requirements

**Test Coverage:**

- Unit tests for all billing components
- Bill state management testing
- Product search functionality testing
- Real-time calculation testing
- Responsive design testing
- Integration tests for bill creation flow

### Technical Constraints

**Performance Requirements:**

- Search debouncing: 300ms delay
- Real-time calculations: Update within 100ms
- Product search: Return results within 200ms
- Mobile responsiveness: Touch-friendly interface

**Business Logic:**

- Bill totals: Sum of (quantity × price) for all line items
- Tax calculation: Based on shop configuration (future enhancement)
- Stock validation: Check availability before adding to bill
- Draft bills: Allow modifications until completion

**UX Requirements:**

- One-click product addition
- Visual feedback for all actions
- Clear product identification with images
- Intuitive quantity adjustment controls
- Mobile-first responsive design

## Testing

**Testing Standards:**

- Unit tests for all billing components using React Testing Library
- Bill state management testing with various scenarios
- Product search functionality testing with mock data
- Real-time calculation testing with edge cases
- Responsive design testing across different screen sizes
- Integration testing for complete billing workflow

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-27 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_This section will be populated by the QA agent during review_
