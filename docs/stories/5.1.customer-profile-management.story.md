# Story 5.1: Customer Profile Management

## Status
Draft

## Story
**As a** shop owner,
**I want** to create and manage customer profiles with contact information and preferences,
**so that** I can build customer relationships and provide personalized service

## Acceptance Criteria
1. User can create new customer profiles with name and phone number
2. User can add additional customer details (email, address, preferences)
3. User can search and view existing customer profiles
4. User can edit customer information
5. Customer profiles show purchase history summary
6. User can categorize customers (VIP, Regular, New)
7. Customer data is organized and easily searchable
8. Customer profiles integrate with billing system

## Tasks / Subtasks
- [ ] Task 1: Create customer data models and API (AC: 1-8)
  - [ ] Implement Customer schema with required fields
  - [ ] Create customer CRUD API endpoints
  - [ ] Add customer search and filtering functionality
  - [ ] Implement customer categorization system
- [ ] Task 2: Build customer management UI components (AC: 1-8)
  - [ ] Create CustomerForm component for add/edit
  - [ ] Build CustomerList component with search and filters
  - [ ] Implement CustomerCard component for individual profiles
  - [ ] Add CustomerSearch component with suggestions
- [ ] Task 3: Implement customer CRUD operations (AC: 1-4)
  - [ ] Create add customer functionality with validation
  - [ ] Implement edit customer with pre-populated form
  - [ ] Add customer search by name or phone
  - [ ] Build customer list with pagination and sorting
- [ ] Task 4: Add customer categorization and organization (AC: 5-7)
  - [ ] Implement customer categories (VIP, Regular, New)
  - [ ] Add purchase history summary display
  - [ ] Create customer preferences tracking
  - [ ] Build customer analytics dashboard
- [ ] Task 5: Integrate with billing system (AC: 8)
  - [ ] Link customers to bills during billing
  - [ ] Update customer purchase history automatically
  - [ ] Add customer selection in billing interface
  - [ ] Implement customer lookup during checkout

## Dev Notes

### Previous Story Insights
This story builds on Epic 1 (User & Shop Onboarding), Epic 2 (Product & Inventory Management), and Epic 3 (Core Billing Engine) and requires the billing system and product management to be complete.

### Data Models
**Customer Schema:**
- `shop`: { type: ObjectId, ref: 'Shop', required: true }
- `name`: { type: String, required: true, trim: true }
- `phone`: { type: String, required: true, unique: true }
- `email`: { type: String, trim: true, lowercase: true }
- `address`: { type: String, trim: true }
- `category`: { type: String, enum: ['VIP', 'Regular', 'New'], default: 'New' }
- `preferences`: { type: String, trim: true }
- `totalPurchases`: { type: Number, default: 0 }
- `totalSpent`: { type: Number, default: 0 }
- `lastVisit`: { type: Date }
- `isActive`: { type: Boolean, default: true }
- `createdAt`: { type: Date, default: Date.now }
- `updatedAt`: { type: Date, default: Date.now }

**Customer Purchase History Schema:**
- `customer`: { type: ObjectId, ref: 'Customer', required: true }
- `bill`: { type: ObjectId, ref: 'Bill', required: true }
- `amount`: { type: Number, required: true }
- `date`: { type: Date, required: true }
- `products`: [ { `productId`: ObjectId, `name`: String, `quantity`: Number } ]

[Source: docs/architecture/01-system-architecture-document-saral-vyapar.md#4.3 Database (Persistence)]

### API Specifications
**Customer Endpoints:**
- `POST /api/customers` - Create new customer
- `GET /api/customers` - Get customers with search/filter/pagination
- `GET /api/customers/:id` - Get single customer with history
- `PUT /api/customers/:id` - Update customer
- `DELETE /api/customers/:id` - Soft delete customer
- `GET /api/customers/search?q={query}` - Search customers by name/phone

**Customer Analytics Endpoints:**
- `GET /api/customers/:id/history` - Get customer purchase history
- `GET /api/customers/analytics/summary` - Get customer analytics summary
- `GET /api/customers/categories/stats` - Get customer category statistics

**Query Parameters:**
- `search` - Customer name or phone search
- `category` - Filter by customer category
- `sort` - Sort by name, totalSpent, lastVisit, createdAt
- `page` - Pagination page number
- `limit` - Items per page

### Component Specifications
**Frontend Components:**
- `CustomerForm` - Add/edit customer form with validation
- `CustomerList` - Customer grid/list with search and filters
- `CustomerCard` - Individual customer profile card
- `CustomerSearch` - Search input with customer suggestions
- `CustomerFilters` - Filter controls for category, etc.
- `CustomerHistory` - Purchase history display component
- `CustomerAnalytics` - Customer performance metrics
- `CustomerCategoryBadge` - Visual category indicator

**Form Fields:**
- Customer name (required)
- Phone number (required, unique)
- Email address (optional)
- Address (optional)
- Category selection (VIP, Regular, New)
- Preferences (optional, text area)
- Notes (optional)

**Customer Card Display:**
- Name and phone prominently displayed
- Category badge with color coding
- Total purchases and spending
- Last visit date
- Quick action buttons (edit, view history)

### File Locations
- `src/components/customers/CustomerForm.tsx`
- `src/components/customers/CustomerList.tsx`
- `src/components/customers/CustomerCard.tsx`
- `src/components/customers/CustomerSearch.tsx`
- `src/components/customers/CustomerFilters.tsx`
- `src/components/customers/CustomerHistory.tsx`
- `src/components/customers/CustomerAnalytics.tsx`
- `src/components/customers/CustomerCategoryBadge.tsx`
- `src/pages/Customers.tsx`
- `src/pages/AddCustomer.tsx`
- `src/pages/EditCustomer.tsx`
- `src/pages/CustomerProfile.tsx`
- `src/api/customers.ts` - Customer API functions
- `src/utils/customerUtils.ts` - Customer validation and helpers

### Testing Requirements
**Test Coverage:**
- Unit tests for all customer components
- Form validation testing (required fields, phone format, email format)
- API integration tests for CRUD operations
- Search and filter functionality testing
- Customer categorization testing
- Purchase history integration testing

### Technical Constraints
**Validation Requirements:**
- Customer name: Required, 2-100 characters
- Phone number: Required, valid Indian phone format
- Email: Optional, valid email format if provided
- Category: Required, must be one of predefined values

**Business Logic:**
- Customer categories: New (0-5 purchases), Regular (6-20 purchases), VIP (20+ purchases)
- Total purchases: Count of completed bills
- Total spent: Sum of all bill amounts
- Last visit: Most recent bill date

**Integration Points:**
- Billing system: Link customers to bills
- Analytics: Update customer metrics on bill completion
- Search: Real-time customer lookup during billing
- History: Automatic purchase history updates

**Performance Considerations:**
- Customer search: Debounced with 300ms delay
- Purchase history: Paginated (20 items per page)
- Customer list: Pagination with search optimization
- Real-time updates: Customer metrics on bill completion

## Testing
**Testing Standards:**
- Unit tests for all customer components using React Testing Library
- Form validation testing with various input scenarios
- API integration tests with mocked endpoints
- Search and filter functionality testing
- Customer categorization and analytics testing
- Responsive design testing across different screen sizes
- Integration testing with billing system

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent during review*
